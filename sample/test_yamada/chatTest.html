<!DOCTYPE HTML> 
<html lang="en"> 
<head>
<title>PeerJS chat demo</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta http-equiv="Content-Language" content="en-us"> 

<!-- <link href="fancy.css" rel="stylesheet" type="text/css"> -->

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>

<script>
	// Connect to PeerJS, have server assign an ID instead of providing one
	// Showing off some of the configs available with PeerJS :).
	var peer = new Peer({
		// Set API key for cloud server (you don't need this if you're running your
		// own.
		key: 'cc6f5bfa-ec91-11e3-8c36-09d78563cbeb',
		// localhostは以下のキーを使用
		//  key: '6165842a-5c0d-11e3-b514-75d3313b9d05',

		// Set highest debug level (log everything!).
		debug: 3,

		// Set a logging function:
		/* logFunction: function() {
			var copy = Array.prototype.slice.call(arguments).join(' ');
			$('.log').append(copy + '<br>');
	  	}*/
	});
	
	var connectedPeers = {};
	var myId;
	
	// Show this peer's ID.
	peer.on('open', function(id){
		$('#pid').text(id);
		myId = id;
	});

	// Await connections from others
	peer.on('connection', connect);

	// Handle a connection object.
	function connect(c) {
		// Handle a chat connection.
		if (c.label === 'chat') {
			if(connectedPeers[c.metadata] === null){
				connectedPeers[c.metadata] = c;
			}
			
			/*
			接続したUser情報をstoreに追加
			接続しました？ポップアップかチャットで出力
			*/

			c.on('data', function(data) {
			      $('#chatSpace').append('<div><span class="peer">' + c.peer + '</span>: ' + data + '</div>');
			      /*
		      		必要であれば、取得したメッセージをローカルストレージに保存
			      */
			});

			// ページ遷移でもこのイベントが発生するためすごく不便だと思うの
			c.on('close', function() {
				alert(c.peer + ' has left the chat.');
				
				if ($('.connection').length === 0) {
					$('.filler').show();
				}
				
				// delete connectedPeers[c.peer];
				
				/*
				// チェックアウト時に使おう
				var meObj = JSON.parse(localStorage.getItem("me"));
				var storeObj = JSON.parse(localStorage.getItem(meObj.store_id));
				var userArray = storeObj.user_ids.split(",");
				
				for(var index in userArray){
					var userObj = JSON.parse(localStorage.getItem(userArray[index]));
					if(c.peer === userObj.peer_id){
						userArray.aplit(index, 1);
						break;
					}
				}
				
				//ログアウトしました
				*/
				
			});
		} else if (c.label === 'file') {
			c.on('data', function(data) {
				// If we're getting a file, create a URL for it.
				if (data.constructor === ArrayBuffer) {
					var dataView = new Uint8Array(data);
					var dataBlob = new Blob([dataView]);
					var url = window.URL.createObjectURL(dataBlob);
					$('#' + c.peer).find('.messages').append('<div><span class="file">' +
						c.peer + ' has sent you a <a target="_blank" href="' + url + '">file</a>.</span></div>');
		      	}
	    	});
		} else if(c.label === 'ask') {
			c.on('data', function(data) {
				var userObj = localStorage.getItem(c.metadata);
				if(userObj !== null){
					localStorage.removeItem(c.metadata);
				}
				
				localStorage.setItem(c.metadata, data);
			});
			
			var meObj = localStorage.getItem("me");
			var userObj = localStorage.getItem(meObj.user_id);
			c.send(userObj);
		}
		
		
	  	connectedPeers[c.peer] = 1;
	}
	
	// ページ遷移時、peerIdが変更されてしまうため再接続
	$(window).load(function(){
		// Test用meTableを作成
		var meObj = {
			"user_id" : "user_1",
			"peer_id" : myId,
			"store_id": "store_1234-5678_876-5432"
			}
		localStorage.setItem("me", JSON.stringify(meObj));
		
		var activeList;
		$.get(
			"https://skyway.io/active/list/cc6f5bfa-ec91-11e3-8c36-09d78563cbeb",
			function(list){
				activeList = list;	
			}
		);
		
		var meObj = JSON.parse(localStorage.getItem("me"));
		var storeObj = JSON.parse(localStorage.getItem(meObj.store_id));
		var userArray = storeObj.user_ids.split(",");
		
		for(var index in userArray){
			var userObj = JSON.parse(localStorage.getItem(userArray[index]));
			var c = peer.connect(userObj.peer_id, {
					// label: 'ask',
					label: 'chat',
					serialization: 'none',
					metadata: meObj.user_id
		      	});
		      	
		      	c.on('open', function() {
				connect(c);
			});
				
			c.on('error', function(err) { alert(err); });
			var f = peer.connect(userObj.peer_id, { label: 'file', reliable: true });
			f.on('open', function() {
				connect(f);
			});
			f.on('error', function(err) { alert(err); });
		}
		
		// チャット出力処理
		var chatArray = storeObj.chat_ids.split(",");
		
		for(var index in chatArray){
			var chatObj = JSON.parse(localStorage.getItem(chatArray[index]));
			var userObj = JSON.parse(localStorage.getItem(chatObj.user_id));
			$('#chatSpace').append('<div>[' + chatObj.datetime + ']' + userObj.name + '</div>')
									.append('<p></p>').append(chatObj.msg);
		}
	});

	$(document).ready(function() {
		function doNothing(e){
			e.preventDefault();
			e.stopPropagation();
		}

		/*
		// Connect処理はチェックイン画面で行う
		// Connect to a peer
		$('#connect').click(function() {
			requestedPeer = $('#rid').val();
		    if (!connectedPeers[requestedPeer]) {
				// Create 2 connections, one labelled chat and another labelled file.
				var c = peer.connect(requestedPeer, {
					label: 'chat',
					serialization: 'none',
					metadata: {message: 'hi i want to chat with you!'}
		      	});
		      	
		      	c.on('open', function() {
					connect(c);
				});
				
				c.on('error', function(err) { alert(err); });
				var f = peer.connect(requestedPeer, { label: 'file', reliable: true });
				f.on('open', function() {
					connect(f);
				});
				f.on('error', function(err) { alert(err); });
		    }
		    connectedPeers[requestedPeer] = 1;
		});
		*/

		/*
		// Checkoutの処理はどこで行うの？
			下記処理を追加する必要がある
			localStorage内のチャットデータを削除
			ユーザデータも不要？
		// Close a connection.
		$('#close').click(function() {
			eachActiveConnection(function(c) {
				c.close();
		    });
		});
		*/
		
		// Send a chat message to all active connections.
		$('#send').submit(function(e) {
			e.preventDefault();
			// For each active connection, send the message.
			var msg = $('#text').val();
			eachActiveConnection(function(c) {
				if (c.label === 'chat') {
					c.send(msg);
	      		}
	    	});
	    	
			// 自身に表示する処理
			var addmsg = $('<div>You:</div>').append('<p></p>').append(msg);
			$('#chatSpace').append(addmsg);
			
		    $('#text').val('');
		    $('#text').focus();
	  	});

		/*
		// Goes through each active peer and calls FN on its connections.
		function eachActiveConnection(fn) {
			var actives = $('.active');
			var checkedIds = {};
			actives.each(function() {
				var peerId = $(this).attr('id');

				if (!checkedIds[peerId]) {
					var conns = peer.connections[peerId];
					for (var i = 0, ii = conns.length; i < ii; i += 1) {
						var conn = conns[i];
						fn(conn, $(this));
					}
				}

				checkedIds[peerId] = 1;
			});
		}
		*/
		
		function eachActiveConnection(fn) {
			var meObj = JSON.parse(localStorage.getItem("me"));
			var storeObj = JSON.parse(localStorage.getItem(meObj.store_id));
			var userArray = storeObj.user_ids.split(",");
			
			for(var index in userArray){
				var userObj = JSON.parse(localStorage.getItem(userArray[index]));
				fn(connectedPeers[userArray[index]]);
			}
		}
		
		// Show browser version
		$('#browsers').text(navigator.userAgent);
	});

	// Make sure things clean up properly.

	window.onunload = window.onbeforeunload = function(e) {
		if (!!peer && !peer.destroyed) {
		    peer.destroy();
		}
	};

</script>
</head> 
 
<body> 
  <a href="https://github.com/peers/peerjs"><img style="position: absolute; top: 0; right: 0; border: 0;"
    src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"
    alt="Fork me on GitHub"></a>

  <div id="actions">
    Your PeerJS ID is <span id="pid"></span><br>
   
    <form id="send">
      <input type="text" id="text" placeholder="Enter message"><input class="button" type="submit" value="Send to selected peers">
    </form>
  </div>
  
<div id="chatSpace"></div>
</body> 
</html> 

