<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if IE 9]>    <html class="no-js ie9" lang="en"> <![endif]-->
<!-- Consider adding an manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 9]><!--> <html class="no-js" lang="en" itemscope itemtype="http://schema.org/Product"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <!-- Use the .htaccess and remove these lines to avoid edge case issues.
       More info: h5bp.com/b/378 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>列's Enjoy!!</title>
  <meta name="description" content="" />
  <meta name="keywords" content="" />
  <meta name="author" content="humans.txt">

  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />

  <!-- Facebook Metadata /-->
  <meta property="fb:page_id" content="" />
  <meta property="og:image" content="" />
  <meta property="og:description" content=""/>
  <meta property="og:title" content=""/>

  <!-- Google+ Metadata /-->
  <meta itemprop="name" content="">
  <meta itemprop="description" content="">
  <meta itemprop="image" content="">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- We highly recommend you use SASS and write your custom styles in sass/_custom.scss.
     However, there is a blank style.css in the css directory should you prefer -->
  <link rel="stylesheet" href="css/gumby.css">
  <link rel="stylesheet" href="css/custom.css">

  <script src="js/libs/modernizr-2.6.2.min.js"></script>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="https://skyway.io/dist/0.3/peer.js"></script>
  
  <script>
  	// Connect to PeerJS, have server assign an ID instead of providing one
  	// Showing off some of the configs available with PeerJS :).
  	var peer = new Peer({
  		// Set API key for cloud server (you don't need this if you're running your
  		// own.
  		key: 'cc6f5bfa-ec91-11e3-8c36-09d78563cbeb',
  		// localhostは以下のキーを使用
  		//  key: '6165842a-5c0d-11e3-b514-75d3313b9d05',
  
  		// Set highest debug level (log everything!).
  		debug: 3,
  
  		// Set a logging function:
  		/* logFunction: function() {
  			var copy = Array.prototype.slice.call(arguments).join(' ');
  			$('.log').append(copy + '<br>');
  	  	}*/
  	});
  	
  	var connectedPeers = {}
  	var myId;
  	var msgCnt = 0;
  	var meObj = JSON.parse(localStorage.getItem("me"));
  	
  	function addchat(addData){
  		while(1){
  				var chatObj = localStorage.getItem('chat_' + msgCnt);
  				if(chatObj === null){
  					localStorage.setItem('chat_' + msgCnt, addData);
  					break;
  				}
  				msgCnt++;
  			}
  	}
  	
  	// Show this peer's ID.
  	peer.on('open', function(id){
  		$('#pid').text(id);
  		myId = id;
  	});
  
  	// Await connections from others
  	peer.on('connection', connect);
  
  	// Handle a connection object.
  	function connect(c) {
  		// Handle a chat connection.
  		if (c.label === 'chat') {
  			connectedPeers[c.metadata] = new dataConnection();
  			connectedPeers[c.metadata] = c;
  			
  			/*
  			接続したUser情報をstoreに追加
  			接続しました？ポップアップかチャットで出力
  			*/
  
  			c.on('data', function(data) {
  				// チャットを追加する
  				addchat(data);
  				
  				var getMsgObj = JSON.parce(data);
  			      	$('#chatSpace').append('<div><span class="peer">' + getMsgObj.user_id + '</span>: ' + getMsgObj.msg + '</div>');
  			});
  
  			// ページ遷移でもこのイベントが発生するためすごく不便だと思うの
  			c.on('close', function() {
  				alert(c.peer + ' has left the chat.');
  				
  				if ($('.connection').length === 0) {
  					$('.filler').show();
  				}
  				
  				// delete connectedPeers[c.peer];
  				
  				
  				/*
  				チェックアウト時に使おう
  				離れたら再度チェックイン？（再接続する）用に実装する
  				*/
  				
  				// var meObj = JSON.parse(localStorage.getItem("me")); いちいち作るの？
  				var storeObj = JSON.parse(localStorage.getItem('store_' + meObj.store_id));
  				var userArray = storeObj.user_ids.split(",");
  				
  				for(var index in userArray){
  					var userObj = JSON.parse(localStorage.getItem('user_' + userArray[index]));
  					if(c.peer === userObj.peer_id){
  						userArray.split(index, 1);
  						break;
  					}
  				}
  				
  				//ログアウトしました
  				alert("チェックアウトしました");
  				
  			});
  		} else if (c.label === 'file') {
  			c.on('data', function(data) {
  				// If we're getting a file, create a URL for it.
  				if (data.constructor === ArrayBuffer) {
  					var dataView = new Uint8Array(data);
  					var dataBlob = new Blob([dataView]);
  					var url = window.URL.createObjectURL(dataBlob);
  					$('#chat-space')
  			        .append('<li class="field chat"><div class="user">' + 
                        '<a href="show_profile.html" class="photo"><img src=' + "img/noimage.png" + '></a>' +
                        '<a href="show_profile.html" class="name">' + userObj.name + '</a>'  +
                        '</div>' +
                        '<p class="msg">' +
                        '<time>' + chatObj.date + '</time>' +
                        chatObj.msg +
                        '</p></li>'
                );
  				}
			  });
		  } else if(c.label === 'ask') {
			  c.on('data', function(data) {
				  var getObj = JSON.parse(data);
				  if(getObj.type === 'sendUserData'){
  					var userObj = localStorage.getItem('user_' + getObj.user_id);
  					if(userObj !== null){
  						localStorage.removeItem('user_' + getObj.user_id);
  					}
					
					localStorage.setItem('user_' + getObj.user_id, getObj.user_Data);
				  }
			  });
  			
  			// var meObj = localStorage.getItem("me");
  			var userObj = localStorage.getItem('user_' + meObj.user_id);
  			var sendDataObj = {
  					'type' : "sendUserData",
  					'user_id': meObj.user_id,
  					'user_Data': localStorage.getItem(meObj.user_id)
  			};
  				
  			c.send(JSON.stringify(sendDataObj));
  		}
  	}
  	
  	// ページ遷移時、peerIdが変更されてしまうため再接続
  	$(window).load(function(){
  		// Test用meTableを作成
  		var meDummyObj = {
  			"user_id" : "1",
  			"peer_id" : myId,
  			"store_id": "1234-5678_876-5432"
  			};
  		var getmeObj = localStorage.getItem("me");
  		
  		if(getmeObj === null){
  			localStorage.setItem("me", JSON.stringify(meDummyObj));
  		}else{
  			meObj = meDummyObj;
  		}
  		
  		var getUserObj = localStorage.getItem('user_' + meDummyObj.user_id);
  		
  		if(getUserObj === null){
  			var userObj = {
  				"name" : "tester",
  				"sex" : "1",
  				"state" : "10",
  				"age" : "20",
  				"comment" : "つかれらの",
  				"photo" : "???",
  				"matrix_log_ids" : null,
  				"peer_id" : myId
  			};
  			
  			localStorage.setItem("user_" + meDummyObj.user_id , JSON.stringify(userObj));
  		}
  			
  		var getStoreObj = localStorage.getItem('store_' + meObj.store_id);
  		if(getStoreObj === null){
  			var storeDummyObj = {
	  			"name" : "ギャレットポップコーン原宿店",
	  			"user_ids" : "1",
	  			"chat_ids" : "1,2,3,4,5,6,7,8,9,10"
  			};
  			
  			localStorage.setItem("store_" + meObj.store_id, JSON.stringify(storeDummyObj));
  		}
  		
  		// 残りの足りないデータはChromeさんのお力でなんとかしたらいいんじゃない
  		// ここまで
  		
  		// ページ遷移時のため 全てのユーザと通信
  		var activeList;
  		$.get(
  			"https://skyway.io/active/list/cc6f5bfa-ec91-11e3-8c36-09d78563cbeb",
  			function(list){
  				activeList = list;	
  			}
  		);
  		/* 
  		   全てのユーザ情報を取得？
  		   取得したユーザ情報から現在同じストアにチェックインしている人を確認
  		   （store_xxxにuser_idを追加する）
  		   以降は新たにチェックインするたびにstore_xxxにuser_idを追加的な処理がはいるとこ
  		*/
  		
  		// me取得跡地
  		var storeObj = JSON.parse(localStorage.getItem('store_' + meObj.store_id));
  		var userArray = storeObj.user_ids.split(",");
  		
  		for(var index in userArray){
  			var userObj = JSON.parse(localStorage.getItem('user_' + userArray[index]));
  			if(userObj !== null){
  				var c = peer.connect(userObj.peer_id, {
  						// label: 'ask',
  						label: 'chat',
  						serialization: 'none',
  						metadata: meObj.user_id
  			      	});
  			      	c.on('open', function() {
  			      		if(connectedPeers[c.metadata] === null){
  						connectedPeers[c.metadata] = c;
  					}
  					
  					var sendDataObj = {
  						'type' : "sendUserData",
  						'user_id': meObj.user_id,
  						'user_Data': localStorage.getItem('user_' + meObj.user_id)
  					};
  					
  					c.send(JSON.stringify(sendDataObj));
  					connect(c);
  				});
  					
  				c.on('error', function(err) { alert(err); });
  				var f = peer.connect(userObj.peer_id, { label: 'file', reliable: true });
  				f.on('open', function() {
  					connect(f);
  				});
  				f.on('error', function(err) { alert(err); });
  			}
  		}
  		
  		// チャット出力処理
  		if(storeObj.chat_ids !== null){
  			var chatArray = storeObj.chat_ids.split(",");
  			
  			for(var index in chatArray){
  				var chatObj = JSON.parse(localStorage.getItem('chat_' + chatArray[index]));
  				if(chatObj !== null){
  					// てきとーに表示、時系列並び替え必要かも
  					var userObj = JSON.parse(localStorage.getItem('user_' + chatObj.user_id));
  					$('#chat-space').append('<li class="field chat">' + 
  			      			'<div class="user">' + 
                				'<a href="show_profile.html" class="photo"><img src=' + "img/noimage.png" + '></a>' +
                				'<a href="show_profile.html" class="name">' + userObj.name + '</a>'  +
        				        '</div>' +
				                '<p class="msg">' +
                        			'<time>' + chatObj.date + '</time>' +
                				chatObj.msg +
                        			'</p></li>');
  				}
  			}
  		}
  	});
  
  	$(document).ready(function() {
  		function doNothing(e){
  			e.preventDefault();
  			e.stopPropagation();
  		}
  
  		/*
  		// Connect処理はチェックイン画面で行う
  		// Connect to a peer
  		$('#connect').click(function() {
  			requestedPeer = $('#rid').val();
  		    if (!connectedPeers[requestedPeer]) {
  				// Create 2 connections, one labelled chat and another labelled file.
  				var c = peer.connect(requestedPeer, {
  					label: 'chat',
  					serialization: 'none',
  					metadata: {message: 'hi i want to chat with you!'}
  		      	});
  		      	
  		      	c.on('open', function() {
  					connect(c);
  				});
  				
  				c.on('error', function(err) { alert(err); });
  				var f = peer.connect(requestedPeer, { label: 'file', reliable: true });
  				f.on('open', function() {
  					connect(f);
  				});
  				f.on('error', function(err) { alert(err); });
  		    }
  		    connectedPeers[requestedPeer] = 1;
  		});
  		*/
  
  		/*
  		// Checkoutの処理はどこで行うの？
  			下記処理を追加する必要がある
  			localStorage内のチャットデータを削除
  			ユーザデータも不要？
  		// Close a connection.
  		$('#close').click(function() {
  			eachActiveConnection(function(c) {
  				c.close();
  		    });
  		});
  		*/
  		
  		// Send a chat message to all active connections.
  		$('#send').submit(function(e) {
  			e.preventDefault();
  			// For each active connection, send the message.
  			var nowTime = new Date();
  			// 日時を数値化　もっといい方法あるかも
  			var strTime = nowTime.getFullYear() + '-' +
  				      (nowTime.getMonth() + 1) + '-' +
  				      nowTime.getDate() + " " +
  				      nowTime.getHours() + ':' +
  				      nowTime.getMinutes() + ':' +
  				      nowTime.getSeconds();
  			var msgObj = {
  				'store_id': meObj.store_id,
  				'user_id': meObj.user_id,
  				'msg' : $('#text').val(),
  				'date' : strTime
  			};
  			// 接続済みのすべてのユーザにメッセージを送信
  			eachActiveConnection(function(c) {
  				if (c.label === 'chat') {
  					c.send(JSON.stringify(msgObj));
  	      			}
  	    		});
  	    		
  	    		var userObj = JSON.parse(localStorage.getItem('user_' + meObj.user_id));
  			// 自身に表示する処理
  			$('#chat-space')
  			      .append('<li class="field chat me"><div class="user">' + 
                        '<a href="show_profile.html" class="photo"><img src=' + "img/noimage.png" + '></a>' +
                        '<a href="show_profile.html" class="name">' + userObj.name + '</a>'  +
                        '</div>' +
                        '<p class="msg">' +
                        '<time>' + msgObj.date + '</time>' +
                        msgObj.msg +
                        '</p></li>');
  			
  			// チャットに追加する処理
  			addchat(JSON.stringify(msgObj));
  			
  		    $('#text').val('');
  		    $('#text').focus();
  	  	});
  		
  		function eachActiveConnection(fn) {
  			// var meObj = JSON.parse(localStorage.getItem("me"));
  			var storeObj = JSON.parse(localStorage.getItem('store_' + meObj.store_id));
  			var userArray = storeObj.user_ids.split(",");
  			
  			for(var index in userArray){
  				if(userArray[index] != meObj.user_id){
  					var userObj = JSON.parse(localStorage.getItem('user_' + userArray[index]));
  					fn(connectedPeers[userArray[index]]);
  				}
  			}
  		}
  	});
  
  	// Make sure things clean up properly.
  
  	window.onunload = window.onbeforeunload = function(e) {
  		if (!!peer && !peer.destroyed) {
  		    peer.destroy();
  		}
  	};
  
  </script>
</head>

<style>
  .btn,.drawer { margin-bottom:10px; }
  .drawer { text-align: center; }
  h1.lead { border-bottom: 1px dotted #ccc; margin-bottom: 30px; }
  h4.lead { margin-bottom:10px; }
  #icon_map ul li { font-size: 16px; }
  .smallify { font-size: 13px; }
  .modal h2, .modal .btn { margin: 5% 0 20px; }
  .ttip.example { float: left; background: #eee; border: 1px dotted #ccc; padding: 20px; }
</style>

<body>

  <!-- Grab Google CDN's jQuery, fall back to local if offline -->
  <!-- 2.0 for modern browsers, 1.10 for .oldie -->
  <script>
  var oldieCheck = Boolean(document.getElementsByTagName('html')[0].className.match(/\soldie\s/g));
  if(!oldieCheck) {
  document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"><\/script>');
  } else {
  document.write('<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"><\/script>');
  }
  </script>
  <script>
  if(!window.jQuery) {
  if(!oldieCheck) {
    document.write('<script src="js/libs/jquery-2.0.2.min.js"><\/script>');
  } else {
    document.write('<script src="js/libs/jquery-1.10.1.min.js"><\/script>');
  }
  }
  </script>
  
  <!--{共通ヘッダー ここから}-->
  <header class="navbar" id="nav1">
    <div class="row">
      <a class="toggle" gumby-trigger="#nav1 > .row > ul" href="#"><i class="icon-menu"></i></a>
      <h1 class="four columns logo">
        <a href="index.html">
          <img src="img/header_logo.png" gumby-retina />
        </a>
      </h1>
      <ul class="eight columns">
        <li><a href="chat.html"><i class="icon-chat"></i> チャット</a></li>
        <li><a href="map.html"><i class="icon-globe"></i> 行列MAP</a></li>
        <li><a href="ranking.html"><i class="icon-trophy"></i> ランキング</a></li>
        <li><a href="edit_profile.html"><i class="icon-user"></i> プロフィール編集</a></li>
        <li><a href="game.html"><i class="icon-star"></i> しりとり</a></li>
        <li><a href="checkout.html"><i class="icon-logout"></i> チェックアウト</a></li>
      </ul>
    </div>
  </header>
  <!--{共通ヘッダー ここまで}-->
  <div class="wrapper wrapper-chat">





  <!--{コンテンツ ここから}-->
  <div class="row page-header">
    <div class="twelve columns">
      <h3><i class="icon-chat"></i> Eggs'n Things原宿店</h3>
    </div>
  </div>
  <div class="row chat-timeline">
    <div class="chat-timeline-wrapper">
      <div class="twelve columns">
        <ul id="chat-space">
          <li class="field chat">
            <div class="user">
              <a href="show_profile.html" class="photo"><img src="img/noimage.png"></a>
              <a href="show_profile.html" class="name">UserA</a>
            </div>
            <p class="msg">
              <time>2014-06-20 09:00:00</time>
              行列なう
            </p>
          </li>
  
          <li class="field chat">
            <div class="user">
              <a href="show_profile.html" class="photo"><img src="img/noimage.png"></a>
              <a href="show_profile.html" class="name">UserB</a>
            </div>
            <p class="msg">
              <time>2014-06-20 09:01:00</time>
              行列なう
            </p>
          </li>
  
          <li class="field chat me">
            <div class="user">
              <a href="show_profile.html" class="photo"><img src="img/noimage.png"></a>
              <a href="show_profile.html" class="name">katagiri</a>
            </div>
            <p class="msg">
              <time>2014-06-20 09:0:00</time>
              行列なう
            </p>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="footer-fix footer-fix-chat"></div>
  <!--{コンテンツ ここまで}-->





  </div>
  <!--{共通フッター ここから}-->
  <footer class="row footer footer-chat">
    <div class="row chatsend">
      <div class="twelve columns">
        <ul>
          <li class="field">
          	<form id="send">
	            <div class="medium metro rounded success btn btn-send">
	              <input class = "button" type="submit" >送信</button>
	            </div>
	            <textarea class="input textarea" placeholder="コメント" rows="3" id="text"></textarea>
            	</form>
          </li>
        </ul>
      </div>
    </div>
  </footer>
  <!--{共通フッター ここまで}-->
  <!--
  Include gumby.js followed by UI modules followed by gumby.init.js
  Or concatenate and minify into a single file -->
  <script gumby-touch="js/libs" src="js/libs/gumby.js"></script>
  <script src="js/libs/ui/gumby.retina.js"></script>
  <script src="js/libs/ui/gumby.fixed.js"></script>
  <script src="js/libs/ui/gumby.skiplink.js"></script>
  <script src="js/libs/ui/gumby.toggleswitch.js"></script>
  <script src="js/libs/ui/gumby.checkbox.js"></script>
  <script src="js/libs/ui/gumby.radiobtn.js"></script>
  <script src="js/libs/ui/gumby.tabs.js"></script>
  <script src="js/libs/ui/gumby.navbar.js"></script>
  <script src="js/libs/ui/jquery.validation.js"></script>
  <script src="js/libs/gumby.init.js"></script>

  <!--
  Google's recommended deferred loading of JS
  gumby.min.js contains gumby.js, all UI modules and gumby.init.js

  Note: If you opt to use this method of defered loading,
  ensure that any javascript essential to the initial
  display of the page is included separately in a normal
  script tag.

  <script type="text/javascript">
  function downloadJSAtOnload() {
  var element = document.createElement("script");
  element.src = "js/libs/gumby.min.js";
  document.body.appendChild(element);
  }
  if (window.addEventListener)
  window.addEventListener("load", downloadJSAtOnload, false);
  else if (window.attachEvent)
  window.attachEvent("onload", downloadJSAtOnload);
  else window.onload = downloadJSAtOnload;
  </script> -->

  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <!-- Change UA-XXXXX-X to be your site's ID -->
  <!--<script>
  window._gaq = [['_setAccount','UAXXXXXXXX1'],['_trackPageview'],['_trackPageLoadTime']];
  Modernizr.load({
    load: ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js'
  });
  </script>-->

  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you want to support IE 6.
     chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7 ]>
  <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
  <![endif]-->

  </body>
</html>
